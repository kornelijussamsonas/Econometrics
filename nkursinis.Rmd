---
title: "Įskaitinių eismo įvykių Lietuvos keliuose analizė"
author: "Kornelijus Samsonas, Linas Šyvis"
output:
  html_document: default
  pdf_document:
    latex_engine: xelatex
---

**Reikalingi užduotims paketai.**
```{r, message=F, warning=F}
library(fpp)
```


**Nuskaitome duomenis.**
```{r}
setwd("C:/Users/Linas/Documents/GitHub/Samsonas/Econometrics")
rawdata <- read.csv2("2003-2015.csv", header = T)
agreguoti <- read.csv2("agreguoti2009-2015.csv", header = T)
gyventojai <- read.csv2("gyventojai.csv", header = T, skip = 1)
kor <- read.csv2("koreliacijos.csv", header = T)
```

**Apžvelgiame duomenis**
```{r}
sapply(c(rawdata, agreguoti, gyventojai), head)
```

#Tvarkome duomenis

**Paliekame tik 5 didžiuosius miestus**
```{r}
data <- subset(rawdata, Vieta %in% c("Vilniaus m. sav.", "Kauno m. sav.", "Klaipedos m. sav.", "Siauliu m. sav.", "Panevezio m. sav."))
```

Turime stulpelius "Gimimo data" ir "Stazas". Jų reikšmės tikėtinai stipriai koreliuoja, patikrinkime. Pertvarkysime stulpelio "Gimimo data" reikšmes taip, kad matytume eismo įvykio dalyvio amžių ir patikrinsime koreliaciją su "Stažo" reikšmėmis.

**Stulpelį "Gimimo data" pertvarkome į "Amzius".**
```{r}
Amzius <- as.numeric(format(Sys.Date(), format="%Y")) - as.numeric(format(as.Date(data$Gimimo_data, format="%Y"), format = "%Y"))
data <- data[,-22]
data <- cbind(data, Amzius)
head(data$Amzius)
```

**Patikrinsime koreliaciją.**
```{r}
sum(is.na(data$Stazas))
cor(data$Amzius, data$Stazas)
```
Reikia pašalint NA, kad pamatuot cor.

```{r}
table(data$Blaivumas)
```

Matome, kad stulpelį "Blaivumas" sudaro 6 skirtingos reikšmės. Kadangi, sutrauksime jas visas į "Blaivus" ir "Neblaivus".
```{r}
data[data[, "Blaivumas"] %in% c("Apsvaiges nuo narkotiniu, psichotropiniu ar kitu psichika veikianciu medziagu", "Atsisake buti patikrintas"), "Blaivumas"] <- "Neblaivus"
data$Blaivumas <- factor(data$Blaivumas)
table(data$Blaivumas)
```

```{r}
sum(is.na(data[,a]))
sapply(lapply(data, is.na), sum)
```

Matome, kad yra trūkstamų reikšmių, reikia jas pašalinti.
```{r}
ndata <- data
data <- data[-which(is.na(data$Blaivumas)),]
ndata <- ndata[-lapply(lapply(data, is.na), which),]
```

5 didžiausius Lietuvos miestus lyginsime pagal įvykius 1000-iui gyventojų.

**Sukuriame rodiklį 1000 gyventojų.**
```{r}
tukst <- gyventojai[,3]/1000
gyventojai <- cbind(gyventojai, tukst)
```

#Įvykių sk. 1000-iui gyventojų didžiausiuose miestuose grafikas.

**Išsaugome didžiųjų miestų ir Lietuvos įvykių skaičių ir gyventojų laiko eilutes.
```{r}
ivykiusk <- function(i)
{
  ts(agreguoti[agreguoti$Vieta %in% i, "Visi_ivykiai"], start=c(2009,1), frequency = 12)
}

gyvsk <- function(i)
{
  ts(rep(gyventojai[gyventojai$Vieta == i & gyventojai$Data %in% 2009:2015, "Visi"], each = 12), start = c(2009,1), frequency = 12)
}

ivykiai <- lapply(c(miestai, "Lietuvos Respublika"), ivykiusk)
names(ivykiai)<-sprintf(c(miestai, "Lietuvos Respublika"))
gyven <- lapply(c(miestai, "Lietuvos Respublika"), gyvsk)
names(gyven)<-sprintf(c(miestai, "Lietuvos Respublika"))
```

**Brėžiame grafiką.**
```{r}
plot(0, xlim = c(2009,2015), ylim = c(0,0.3), yaxs="i", xaxs="i", main = "Įvykių skaičius 1000-iui gyventojų")
lines(ivykiai$`Vilniaus m. sav.`*1000/gyven$`Vilniaus m. sav.`, col = "red", lwd = 2)
lines(ivykiai$`Kauno m. sav.`*1000/gyven$`Kauno m. sav.`, col = "green", lwd = 2)
lines(ivykiai$`Klaipedos m. sav.`*1000/gyven$`Klaipedos m. sav.`, col = "blue", lwd = 2)
lines(ivykiai$`Siauliu m. sav.`*1000/gyven$`Siauliu m. sav.`, col = "pink", lwd = 2)
lines(ivykiai$`Panevezio m. sav.`*1000/gyven$`Panevezio m. sav.`, col = "black", lwd = 2)
lines(ivykiai$`Lietuvos Respublika`*1000/gyven$`Lietuvos Respublika`, col = "cyan", lwd = 2)
legend("topright", col = c("red", "green", "blue", "pink", "black", "cyan"), lty = 1, lwd = 2, legend = c("Vilnius", "Kaunas", "Klaipėda", "Šiauliai", "Panevėžys", "Lietuva"), cex = 0.45)
```


#Skaičiuojam neblaivius
```{r}
neblaivus <- as.numeric(0)
blaivus <- as.numeric(0)
for(i in 1:5)
neblaivus[i] <- nrow(data[data[,25] == "Neblaivus" & data[,1] == miestai[i],]) / gyventojai[gyventojai[,1] == 2015 & gyventojai[,2] == miestai[i], 6]
rbind(miestai, round(neblaivus, digits = 3))

for(i in 1:5)
neblaivus[i] <- nrow(data[data[,25] == "Neblaivus" & data[,1] == miestai[i],])
for(i in 1:5)
blaivus[i] <- nrow(data[data[,25] == "Blaivus" & data[,1] == miestai[i],])

tab <-matrix(c(59, 434, 25, 269, 9, 138, 13, 90, 3, 93), nrow=5, byrow=T)
colnames(tab) <- c("taip", "ne")
rownames(tab) <- miestai
prop.test(tab)
```

Matome, kad p-value < 0.05, vadinasi H0 atmetam. Proporcijos statistiškai reikšmingai skiriasi. Patikrinkime tarp kurių miestų proporcijos yra statistiškai reikšmingai skirtingos.

```{r, warning = F}
pairwise.prop.test(tab, p.adjust.method = "none")
```

Proporcijos statistiškai reikšmingai skiriasi tarp Šiauliu m. sav. ir Panevėžio m. sav. ir tarp Vilniaus m. sav. ir Panevėžio m. sav.
Patikrinkime, ar Šiauliuose/Vilniuje įvykių dėl neblaivių vairuotojų kaltės yra statistiškai reikšmingai daugiau negu Panevėžyje.

```{r}
tab1 <-matrix(c(13, 90, 3, 93), nrow=2, byrow=T)
prop.test(tab1, alternative = "greater")

tab2 <-matrix(c(59, 434, 3, 93), nrow=2, byrow=T)
prop.test(tab2, alternative = "greater")
```

Paaiškėjo, kad Šiauliuose/Vilniuje įvykių dėl neblaivių vairuotojų kaltės yra statistiškai reikšmingai daugiau negu Panevėžyje.


#Tikrinam įvykių priklausomybę nuo amžiaus
```{r}
stazas <- cut(data[,24], breaks = c(0, 10, 20, 30, 40, 50, 60))
table(stazas)
```


#Forecastinam autoįvykius
```{r}
b <- ts(agreguoti[agreguoti[,3] == "Vilniaus m. sav.", 4], start=c(2009,1), frequency = 12)
plot(b)
```

```{r}
z <- auto.arima(b)
plot(forecast(z, h = 12))
#salinam sezona
liek <- ts(z$residuals,start=c(2009,1), frequency = 12)
stl <- stl(z$residuals, s.window="periodic")
ser <- liek - stl$time.series[,"seasonal"]
plot(ser)
```


Tikrinsime hipoteze ar Vilniaus mieste eismo ivykiu kaltininkai dazniau yra Vyrai nei moterys.

H0= V sk. = 

```{r}
Vilniusm <- rawdata[rawdata[,1] == "Vilniaus m. sav.",]
Kaunasm <- rawdata[rawdata[,1] == "Kauno m. sav.",]
Siauliaim <- rawdata[rawdata[,1] == "siauliu m. sav.",]
Klaipedam <- rawdata[rawdata[,1] == "Klaipedos m. sav.",]
Panevezysm <- rawdata[rawdata[,1] == "Panevezio m. sav.",]

```


### Kaltininku procentas miestuose (Vyrai/Moterys)

Kaltininku procentas Vilniaus mieste.

```{r}
vyruskV<-sum(na.omit(as.numeric(Vilniusm[,19]=="Vyras")))
moteruskV<-sum(na.omit(as.numeric(Vilniusm[,19]=="Moteris")))
visoV<-(vyruskV+moteruskV)
vyruprocV=vyruskV/visoV*100
moteruprocV=moteruskV/visoV*100
```

Kaltininku procentas Kauno mieste.

```{r}
vyruskK<-sum(na.omit(as.numeric(Kaunasm[,19]=="Vyras")))
moteruskK<-sum(na.omit(as.numeric(Kaunasm[,19]=="Moteris")))
visoK<-(vyruskK+moteruskK)
vyruprocK=vyruskK/visoK*100
moteruprocK=moteruskK/visoK*100
```

Kaltininku procentas Siauliu mieste.

```{r}
vyruskS<-sum(na.omit(as.numeric(Siauliaim[,19]=="Vyras")))
moteruskS<-sum(na.omit(as.numeric(Siauliaim[,19]=="Moteris")))
visoS<-(vyruskS+moteruskS)
vyruprocS=vyruskS/visoS*100
moteruprocS=moteruskS/visoS*100
```


Kaltininku procentas Klaipedos mieste.

```{r}
vyruskKl<-sum(na.omit(as.numeric(Klaipedam[,19]=="Vyras")))
moteruskKl<-sum(na.omit(as.numeric(Klaipedam[,19]=="Moteris")))
visoKl<-(vyruskKl+moteruskKl)
vyruprocKl=vyruskKl/visoKl*100
moteruprocKl=moteruskKl/visoKl*100
```

Kaltininku procentas Panevezio mieste.

```{r}
vyruskP<-sum(na.omit(as.numeric(Panevezysm[,19]=="Vyras")))
moteruskP<-sum(na.omit(as.numeric(Panevezysm[,19]=="Moteris")))
visoP<-(vyruskP+moteruskP)
vyruprocP=vyruskP/visoP*100
moteruprocP=moteruskP/visoP*100
```



Tikrinsime hipoteze ar Vilniaus mieste eismo ivykiu kaltininkai dazniau yra Vyrai nei moterys.

```{r}
Vilniusm <- rawdata[rawdata[,1] == "Vilniaus m. sav.",]
sum(Vilniusm[,"Lytis"]=="Vyras")
```

#koreliacijos
```{r}

kor1 <- kor[-c(1,2,3),-c(1,2,3,5,8)]
kor1[,4] <- as.numeric(levels(kor1[,4]))[kor1[,4]]
cor(kor1)
```


Palyginti zuvusiu/suzeistu menesinius vidurkius tarp laikotarpiu ir vietu.
Ar skiriasi ivykiu skaicius nakti ir diena?

